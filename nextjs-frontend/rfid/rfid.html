<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Smart Gate Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .status-box { padding: 15px; border-radius: 8px; margin: 20px 0; color: white; font-weight: bold; font-size: 1.5em; text-transform: uppercase; }
        .waiting { background-color: #3498db; } /* Blue */
        .scanning { background-color: #e67e22; animation: pulse 1.5s infinite; } /* Orange */
        .pass { background-color: #2ecc71; } /* Green */
        .fail { background-color: #e74c3c; } /* Red */

        .gate-visual { height: 100px; margin: 20px 0; display: flex; align-items: center; justify-content: center; border: 4px dashed #ccc; border-radius: 10px; font-weight: bold; font-size: 20px; }
        .gate-open { border-color: #2ecc71; color: #2ecc71; background: #e8f8f5; }
        .gate-closed { border-color: #e74c3c; color: #e74c3c; background: #fdedec; }

        .ppe-grid { display: flex; justify-content: space-around; margin-top: 30px; }
        .ppe-item { width: 30%; padding: 15px; border-radius: 10px; background: #eee; transition: all 0.3s; opacity: 0.4; display: flex; flex-direction: column; align-items: center; font-weight: bold;}
        .ppe-item span { font-size: 2rem; margin-bottom: 5px; }
        .ppe-active { background: #2ecc71; color: white; opacity: 1; transform: scale(1.1); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); }
        
        button { background-color: #333; color: white; padding: 15px 40px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; margin-top: 25px; transition: background 0.2s; }
        button:hover { background-color: #555; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .log-console { margin-top: 20px; font-family: monospace; color: #666; background: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #ddd; min-height: 20px;}

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöß Smart Safety Gate üöß</h1>
        
        <div id="main-status" class="status-box waiting">SYSTEM READY</div>

        <div id="gate-viz" class="gate-visual gate-closed">
            GATE CLOSED üîí
        </div>

        <div class="ppe-grid">
            <div id="ppe-helmet" class="ppe-item"><span>‚õëÔ∏è</span>Helmet</div>
            <div id="ppe-vest" class="ppe-item"><span>ü¶∫</span>Vest</div>
            <div id="ppe-boots" class="ppe-item"><span>ü•æ</span>Boots</div>
        </div>

        <button id="start-btn" onclick="startScan()">Start Scanning</button>

        <div class="log-console" id="log-msg">Waiting for connection...</div>
    </div>

    <script>
        const ws = new WebSocket("ws://" + window.location.host + "/ws");
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateUI(data);
        };

        function updateUI(data) {
            // Update Log
            if(data.log) document.getElementById("log-msg").innerText = "> " + data.log;

            // Update Status Box & Button
            const statusBox = document.getElementById("main-status");
            const btn = document.getElementById("start-btn");
            
            // Reset base class
            statusBox.className = "status-box";

            if (data.result === "WAITING") {
                statusBox.classList.add("waiting");
                statusBox.innerText = "SYSTEM READY";
                btn.disabled = false;
                btn.innerText = "Start Scanning";
            } else if (data.result === "SCANNING") {
                statusBox.classList.add("scanning");
                statusBox.innerText = "SCANNING...";
                btn.disabled = true;
                btn.innerText = "Scanning...";
            } else if (data.result === "PASS") {
                statusBox.classList.add("pass");
                statusBox.innerText = "ACCESS GRANTED";
                btn.disabled = true;
            } else if (data.result === "FAIL") {
                statusBox.classList.add("fail");
                statusBox.innerText = "ACCESS DENIED";
                btn.disabled = true;
            }

            // Update Gate Visual
            const gateViz = document.getElementById("gate-viz");
            if (data.gate === "OPEN") {
                gateViz.className = "gate-visual gate-open";
                gateViz.innerText = "GATE OPEN üîì";
            } else {
                gateViz.className = "gate-visual gate-closed";
                gateViz.innerText = "GATE CLOSED üîí";
            }

            // Update PPE Icons
            togglePPE("ppe-helmet", data.ppe.helmet);
            togglePPE("ppe-vest", data.ppe.vest);
            togglePPE("ppe-boots", data.ppe.boots);
        }

        function togglePPE(id, isActive) {
            const el = document.getElementById(id);
            if (isActive) el.classList.add("ppe-active");
            else el.classList.remove("ppe-active");
        }

        function startScan() {
            // Optimistic UI Update: Show scanning immediately on click
            const statusBox = document.getElementById("main-status");
            statusBox.className = "status-box scanning";
            statusBox.innerText = "STARTING...";
            document.getElementById("start-btn").disabled = true;
            document.getElementById("log-msg").innerText = "> Sending command...";

            // Send command to backend
            fetch("/start-scan", { method: "POST" });
        }
    </script>
</body>
</html>